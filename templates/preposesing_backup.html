{% extends "base.html" %}
{% block title %}Preprocessing Dataset{% endblock %}

{% block head %}
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
  .progress {
    height: 26px;
    border-radius: 12px;
  }

  .stage-item {
    padding: 10px;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 1px 4px rgba(0, 0, 0, .06);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center
  }

  .preview-img {
    max-width: 180px;
    border-radius: 10px;
    box-shadow: 0 0 6px rgba(0, 0, 0, .15);
    margin: 6px
  }

  #log-box {
    background: #0d1117;
    color: #c9d1d9;
    padding: 10px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 13px;
    height: 220px;
    overflow-y: auto;
    white-space: pre-wrap
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-4">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="fa fa-cogs me-2"></i>control</h5>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="clearOld">
          <label class="form-check-label" for="clearOld">Hapus hasil lama sebelum preprocessing</label>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="fastMode">
          <label class="form-check-label" for="fastMode">Mode Cepat (lewati CLAHE)</label>
        </div>
        <button id="startBtn" class="btn btn-success w-100 fw-bold">üöÄ Mulai Preprocessing</button>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="fa fa-hourglass-half me-2"></i>Status</h5>
        <div class="progress mb-2">
          <div id="progressBar" class="progress-bar progress-bar-striped bg-success" role="progressbar"
            style="width:0%">0%</div>
        </div>
        <div class="d-flex justify-content-between small text-muted">
          <span id="progressText">Belum dimulai</span>
          <span id="etaText">ETA: -</span>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="fa fa-list-check me-2"></i>Tahapan</h5>
        <div class="stage-item" id="stage-crop"><span>1Ô∏è‚É£ Cropping retina (FOV)</span><b>‚è≥</b></div>
        <div class="stage-item" id="stage-illumination"><span>2Ô∏è‚É£ Koreksi pencahayaan</span><b>‚è≥</b></div>
        <div class="stage-item" id="stage-grayworld"><span>3Ô∏è‚É£ Gray world balancing</span><b>‚è≥</b></div>
        <div class="stage-item" id="stage-clahe"><span>4Ô∏è‚É£ Peningkatan kontras (CLAHE)</span><b>‚è≥</b></div>
        <div class="stage-item" id="stage-vessel"><span>5Ô∏è‚É£ Penajaman pembuluh darah</span><b>‚è≥</b></div>
        <div class="stage-item" id="stage-resize"><span>6Ô∏è‚É£ Resize & normalisasi</span><b>‚è≥</b></div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="fa fa-images me-2"></i>Preview (otomatis hingga 12 foto)</h5>
        <div id="previewContainer" class="d-flex flex-wrap"></div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="fa fa-terminal me-2"></i>Log</h5>
        <div id="log-box"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal popup selesai -->
<div class="modal fade" id="doneModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <h5 id="doneMessage">Preprocessing selesai!</h5>
        <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const socket = io();
  const startBtn = document.getElementById('startBtn');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const etaText = document.getElementById('etaText');
  const previewContainer = document.getElementById('previewContainer');
  const logBox = document.getElementById('log-box');
  const doneModal = new bootstrap.Modal(document.getElementById('doneModal'));
  const doneMessageEl = document.getElementById('doneMessage');

  function logMessage(msg) { logBox.textContent += msg + "\n"; logBox.scrollTop = logBox.scrollHeight; }
  function setStage(stage, status) {
    const el = document.getElementById(`stage-${stage}`);
    if (!el) return;
    el.querySelector("b").textContent = (status === "running" ? "üîÑ" : status === "done" ? "‚úÖ" : status === "skipped" ? "‚è≠Ô∏è" : "‚è≥");
  }

  startBtn.addEventListener('click', () => {
    // reset UI
    progressBar.style.width = "0%";
    progressBar.textContent = "0%";
    progressBar.classList.remove('bg-danger');
    progressBar.classList.add('bg-success');
    progressText.textContent = "Menyiapkan...";
    etaText.textContent = "ETA: -";
    previewContainer.innerHTML = "";
    logBox.textContent = "";
    document.querySelectorAll(".stage-item b").forEach(b => b.textContent = "‚è≥");

    const clear = document.getElementById('clearOld').checked;
    const fast = document.getElementById('fastMode').checked;

    fetch(`${location.origin}${'{{ url_for("start_preprocessing") }}'}?clear=${clear}&fast=${fast}`, { method: 'POST' })
      .then(r => r.json())
      .then(d => logMessage("üü¢ " + d.message))
      .catch(err => {
        logMessage("‚ùå Gagal memulai: " + err);
        progressBar.classList.remove('bg-success');
        progressBar.classList.add('bg-danger');
      });
  });

  // Socket handlers
  socket.on('preprocess_log', data => logMessage(data.message));
  socket.on('preprocess_stage', data => setStage(data.stage, data.status));
  socket.on('preprocess_update', data => {
    const p = Math.max(0, Math.min(100, parseInt(data.progress || 0)));
    progressBar.style.width = p + "%";
    progressBar.textContent = p + "%";
    progressText.textContent = data.message || "";
    if (data.eta) etaText.textContent = "ETA: " + data.eta + "s";
  });
  socket.on('preprocess_preview', data => {
    const img = document.createElement("img");
    img.src = "data:image/jpeg;base64," + data.image;
    img.className = "preview-img";
    previewContainer.prepend(img);
    // keep only up to 12
    while (previewContainer.children.length > 12) previewContainer.removeChild(previewContainer.lastChild);
  });
  socket.on('preprocess_done', data => {
    progressBar.style.width = "100%";
    progressBar.textContent = "100%";
    progressText.textContent = data.message || "Selesai.";
    logMessage(data.message || "Selesai.");
  });
  socket.on('preprocess_error', data => {
    progressBar.classList.remove('bg-success');
    progressBar.classList.add('bg-danger');
    progressText.textContent = data.message || "Terjadi kesalahan.";
    logMessage(data.message || "Terjadi kesalahan.");
  });
  socket.on('show_popup', data => {
    doneMessageEl.textContent = data.message || "Preprocessing selesai!";
    doneModal.show();
  });
</script>
{% endblock %}